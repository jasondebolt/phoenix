{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Generates VPC Endpoints.",
  "Parameters": {
    "Environment": {
      "Description": "The environment (dev, testing, prod, etc.) of the VPC.",
      "Type": "String"
    },
    "VPCPrefix": {
      "Description": "The 'export' name prefix of the cloudformation stack for the VPC used by this service.",
      "Type": "String"
    }
  },
  "Resources": {
    "ApiGatewayVPCEndpoint": {
      "Type" : "AWS::EC2::VPCEndpoint",
      "Properties" : {
        "VpcId": {
          "Fn::ImportValue": {"Fn::Sub": [
            "${VPCPrefix}-vpc-VPC", {"VPCPrefix": {"Ref": "VPCPrefix"}}
          ]}
        },
        "ServiceName" : "com.amazonaws.us-east-1.execute-api",
        "VpcEndpointType" : "Interface",
        "PrivateDnsEnabled" : true,
        "SubnetIds" : [
          {"Fn::ImportValue": { "Fn::Sub": [
            "${VPCPrefix}-vpc-PrivateSubnetAZ1", {
              "VPCPrefix": {"Ref": "VPCPrefix"}
            }]
          }},
          {"Fn::ImportValue": { "Fn::Sub": [
            "${VPCPrefix}-vpc-PrivateSubnetAZ2", {
              "VPCPrefix": {"Ref": "VPCPrefix"}
            }]
          }}
        ],
        "SecurityGroupIds" : [
          {"Ref": "APIGatewayVPCEndpointSecurityGroup"}
        ]
      }
    },
    "APIGatewayVPCEndpointSecurityGroup": {
      "Properties": {
        "GroupDescription": "VPC Endpoint Security Group",
        "Tags": [
          {
            "Key": "Name",
            "Value": {"Fn::Sub": [
              "${StackName}-vpc-endpoint-sg", {
                "StackName": {"Ref": "AWS::StackName"}
              }
            ]}
          }
        ],
        "VpcId": {
          "Fn::ImportValue": {"Fn::Sub": [
            "${VPCPrefix}-vpc-VPC", {"VPCPrefix": {"Ref": "VPCPrefix"}}
          ]}
        }
      },
      "Type": "AWS::EC2::SecurityGroup"
    },
    "HTTPSToVPCEndpointInterfaces": {
      "Properties": {
        "FromPort": "443",
        "GroupId": {
          "Ref": "APIGatewayVPCEndpointSecurityGroup"
        },
        "IpProtocol": "tcp",
        "CidrIp": {
          "Fn::ImportValue": {"Fn::Sub": [
            "${VPCPrefix}-vpc-CIDR", {"VPCPrefix": {"Ref": "VPCPrefix"}}
          ]}
        },
        "ToPort": "443"
      },
      "Type": "AWS::EC2::SecurityGroupIngress"
    }
  },
  "Outputs": {
    "ApiGatewayVPCEndpoint": {
      "Export": {
        "Name": {
          "Fn::Join": ["", [{
            "Ref": "AWS::StackName"
          }, "-", "ApiGatewayVPCEndpoint"]]
        }
      },
      "Value": {
        "Ref": "ApiGatewayVPCEndpoint"
      }
    }
  }
}
