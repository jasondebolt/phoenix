{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description" : "Creates a GitHub Pull Request webhook.",
  "Transform" : ["ProjectLambdaMacro"],
  "Parameters": {
    "Version": {
      "Description": "The identifier/version associated with this API.",
      "Type": "String"
    }
  },
  "Resources": {
    "CustomResourceGitHubPullRequestSecret": {
      "Type": "Custom::GitHubPullRequestSecret",
      "Properties": {
        "ServiceToken": {
          "Fn::ImportValue": {
            "Fn::Join": ["-", [
              {"PhoenixSSM": "/microservice/{ProjectName}/global/project-name"},
              "ssm-globals-macro",
              "LambdaSSMSecretArn"
            ]]
          }
        },
        "LambdaVersion": {"Ref": "Version"},
        "SSMSecret": {
          "Name": {"Fn::Join": ["/", [
            "/microservice",
            {"PhoenixSSM": "/microservice/{ProjectName}/global/project-name"},
            "global",
            "github",
            "pull-request-secret"
          ]]},
          "Description": "GitHub pull request secret used for the pull request webhook.",
          "SecretLength": 64,
          "Type": "SecureString",
          "KeyId": "alias/aws/ssm",
          "Overwrite": true
        }
      }
    },
    "LambdaCreatePullRequestWebhook": {
      "Type": "AWS::Lambda::Function",
      "Properties": {
        "Handler": "lambda_function.lambda_handler",
        "Role": {"PhoenixSSM": "/microservice/{ProjectName}/global/iam-role"},
        "Environment": {
          "Variables": {
            "PROJECT_NAME": {"PhoenixSSM": "/microservice/{ProjectName}/global/project-name"}
          }
        },
        "Code": {
          "S3Bucket" : {"PhoenixSSM": "/microservice/{ProjectName}/global/lambda-bucket-name"},
          "S3Key" : {"Fn::Join": ["/", [
            {"Ref": "Version"},
            "create_pull_request_webhook",
            "lambda_function.zip"
          ]]}
        },
        "Runtime": "python3.6",
        "Timeout": "25"
      }
    },
    "CustomResourceCreatePullRequestWebhook": {
      "Type": "Custom::CreatePullRequestWebhook",
      "DependsOn": ["LambdaCreatePullRequestWebhook", "CustomResourceGitHubPullRequestSecret"],
      "Properties": {
        "ServiceToken": {
          "Fn::GetAtt": ["LambdaCreatePullRequestWebhook", "Arn"]
        },
        "LambdaVersion": {"Ref": "Version"},
        "GitHubWebhookParams": {
          "active": true,
          "events": [
            "pull_request"
          ],
          "config": {
            "url": "https://b0pmulccsb.execute-api.us-east-1.amazonaws.com/v0/PullRequests"
          }
        },
        "RepoName": {
          "PhoenixSSM": "/microservice/{ProjectName}/global/git-repo-name"
        }
      }
    }
  },
  "Outputs": {
    "LambdaCreatePullRequestWebhookFunctionName": {
      "Export": {
        "Name": {
          "Fn::Join": ["-", [
            {"PhoenixSSM": "/microservice/{ProjectName}/global/project-name"},
            "pull-request-webhook",
            "LambdaCreatePullRequestWebhookFunctionName"
          ]]
        }
      },
      "Value": {"Ref": "LambdaCreatePullRequestWebhook"}
    }
  }
}
