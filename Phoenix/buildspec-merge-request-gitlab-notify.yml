version: 0.2

phases:
  install:
    commands:
      - nohup /usr/local/bin/dockerd --host=unix:///var/run/docker.sock --host=tcp://127.0.0.1:2375 --storage-driver=overlay&
      - timeout 15s sh -c "until docker info; do echo .; sleep 1; done"
  pre_build:
    commands:
      - # We set AWS_ACCOUNT_ID as an enviornment variable in the CloudFormation template which creates this CodeBuild job.
      - # We assume that the region that the CodeBuild nodes are running (AWS_DEFAULT_REGION) is the same as all other stack resource.
      - aws --version
      - PROJECT_NAME=$(aws ssm get-parameter --name microservice-project-name | jq '.Parameter.Value' | sed -e s/\"//g)
      - GITLAB_ACCESS_TOKEN=$(aws ssm get-parameter --name $PROJECT_NAME-gitlab-access-token --with-decryption | jq '.Parameter.Value' | sed -e s/\"//g)
  build:
    commands:
      - echo Build started on `date`
      - echo GITLAB_ACCESS_TOKEN is $GITLAB_ACCESS_TOKEN
      - |-
        echo "Writing a python-gitlab.cfg config file"
        cat << HERE >> $CODEBUILD_SRC_DIR/python-gitlab.cfg
        [global]
        default = gitlab
        ssl_verify = true
        timeout = 5
        api_version = 3

        [gitlab]
        url = https://gitlab.intranet.solarmosaic.com
        private_token = $GITLAB_ACCESS_TOKEN
        api_version = 4
        HERE
      - |-
        echo "Writing a gitlab API dockerfile"
        cat << HERE >> $CODEBUILD_SRC_DIR/Dockerfile
        FROM python:slim

        # Install python-gitlab
        RUN pip install --upgrade python-gitlab

        # Copy sample configuration file
        COPY python-gitlab.cfg /

        # Define the entrypoint that enable a configuration file
        ENTRYPOINT ["gitlab", "--config-file", "/python-gitlab.cfg"]
        HERE
      - docker build -t python-gitlab:latest .
      - |-
        echo $CODEBUILD_RESOLVED_SOURCE_VERSION
        docker run -i -v $CODEBUILD_SRC_DIR/python-gitlab.cfg:/python-gitlab.cfg python-gitlab:latest project-merge-request-note create --project-id 258 --mr-iid 21 --body '<b>Build Status</b> &nbsp; &nbsp; &nbsp; :thumbsup: :godmode: @ commit '$CODEBUILD_RESOLVED_SOURCE_VERSION
  post_build:
    commands:
      - echo Build completed on `date`
